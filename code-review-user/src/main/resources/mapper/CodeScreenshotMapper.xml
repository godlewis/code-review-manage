<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.company.codereview.user.repository.CodeScreenshotRepository">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.company.codereview.user.entity.CodeScreenshot">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="review_record_id" property="reviewRecordId" jdbcType="BIGINT"/>
        <result column="file_name" property="fileName" jdbcType="VARCHAR"/>
        <result column="file_url" property="fileUrl" jdbcType="VARCHAR"/>
        <result column="file_size" property="fileSize" jdbcType="BIGINT"/>
        <result column="file_type" property="fileType" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="file_path" property="filePath" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="created_by" property="createdBy" jdbcType="BIGINT"/>
        <result column="updated_by" property="updatedBy" jdbcType="BIGINT"/>
        <result column="deleted" property="deleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        id, review_record_id, file_name, file_url, file_size, file_type, 
        description, sort_order, file_path, created_at, updated_at, 
        created_by, updated_by, deleted
    </sql>

    <!-- 根据评审记录ID查询截图列表 -->
    <select id="selectByReviewRecordId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM code_screenshots
        WHERE review_record_id = #{reviewRecordId}
        AND deleted = 0
        ORDER BY sort_order ASC, created_at ASC
    </select>

    <!-- 根据评审记录ID删除截图 -->
    <update id="deleteByReviewRecordId">
        UPDATE code_screenshots 
        SET deleted = 1, updated_at = NOW()
        WHERE review_record_id = #{reviewRecordId}
        AND deleted = 0
    </update>

    <!-- 批量插入截图 -->
    <insert id="batchInsert" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO code_screenshots (
            review_record_id, file_name, file_url, file_size, file_type,
            description, sort_order, file_path, created_at, updated_at,
            created_by, updated_by, deleted
        ) VALUES
        <foreach collection="screenshots" item="item" separator=",">
            (
                #{item.reviewRecordId}, #{item.fileName}, #{item.fileUrl}, 
                #{item.fileSize}, #{item.fileType}, #{item.description}, 
                #{item.sortOrder}, #{item.filePath}, NOW(), NOW(),
                #{item.createdBy}, #{item.updatedBy}, 0
            )
        </foreach>
    </insert>

    <!-- 批量删除截图 -->
    <update id="batchDeleteByIds">
        UPDATE code_screenshots 
        SET deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </update>

    <!-- 更新截图排序 -->
    <update id="updateSortOrder">
        UPDATE code_screenshots 
        SET sort_order = #{sortOrder}, updated_at = NOW()
        WHERE id = #{id}
        AND deleted = 0
    </update>

</mapper>